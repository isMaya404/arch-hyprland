#!/bin/bash

# run this in a systemd timer every couple of mins

STATE_FILE=/tmp/last_battery_notify
BATTERY_LEVEL=$(cat /sys/class/power_supply/BAT1/capacity)
STATUS=$(cat /sys/class/power_supply/BAT1/status)
LAST=$(cat "$STATE_FILE" 2>/dev/null || echo "")

if [[ "$STATUS" == "Discharging" && "$BATTERY_LEVEL" =~ ^(1|20)$ ]] && [[ "$LAST" != "$BATTERY_LEVEL" ]]; then
    notify-send "Battery low $BATTERY_LEVEL%"
    echo "$BATTERY_LEVEL" > "$STATE_FILE"
fi

if [[ "$STATUS" == "Charging" ]]; then
    if [[ "$BATTERY_LEVEL" -ge 90 && "$BATTERY_LEVEL" -le 99 && "$LAST" != "$BATTERY_LEVEL" ]]; then
        notify-send "Battery almost full $BATTERY_LEVEL%"
        echo "$BATTERY_LEVEL" > "$STATE_FILE"
    fi
    if [[ "$BATTERY_LEVEL" -eq 100 && "$LAST" != "$BATTERY_LEVEL" ]]; then
        notify-send --urgency=normal "Battery full $BATTERY_LEVEL%"
        echo "$BATTERY_LEVEL" > "$STATE_FILE"
    fi
fi
